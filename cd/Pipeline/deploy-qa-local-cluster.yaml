apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: deploy-qa-local-cluster
  namespace: sample-php-cicd
spec:
  workspaces:
  - name: shared-workspace
  params:
  - name: git-url
    type: string
    description: url of the git repo for the code of deployment
    default: "https://github.com/giofontana/rhel-ubi-apache-sample.git"
  - name: git-revision
    type: string
    description: revision to be used from repo of the code for deployment
    default: "workshop"
  - name: manistests-path
    type: string
    default: "k8s"
  - name: application-name
    type: string
    description: Name of the ArgoCD Application
    default: "sample-php"
  - name: k8s-dest-server
    type: string
    default: "https://kubernetes.default.svc"    
  - name: k8s-dest-namespace
    type: string
    default: "sample-php"
  tasks:
  - name: fetch-repository
    taskRef:
      name: git-clone
      kind: ClusterTask
    workspaces:
    - name: output
      workspace: shared-workspace
    params:
    - name: url
      value: $(params.git-url)
    - name: subdirectory
      value: ""
    - name: deleteExisting
      value: "true"
    - name: revision
      value: $(params.git-revision)
  - name: deploy-using-argocd
    params:
    - name: git-url
      value: $(params.git-url)
    - name: git-revision
      value: $(params.git-revision)
    - name: application-name
      value: $(params.application-name)
    - name: manifests-path
      value: $(params.manistests-path)
    - name: flags
      value: --insecure
    - name: k8s-dest-server
      value: $(params.k8s-dest-server)
    - name: k8s-dest-namespace
      value: $(params.k8s-dest-namespace)
    taskRef:
      kind: Task
      name: deploy-using-argocd
    workspaces:
    - name: source
      workspace: shared-workspace
    runAfter:
    - fetch-repository
